<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta name="HandheldFriendly" content="True"/>
    <title>Prooph Event Store</title>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
    <link rel="stylesheet"
          href="http://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
    <link rel="stylesheet"
          href="http://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>

    <style>
        body, html {
            height: 100%;
        }

        .page-wrapper {
            min-height: 100%;
            padding-bottom: 204px;
            position: relative;
        }

        /* Header Section */
        header {
            background: white;
            color: black;
            font-weight: 300;
        }

        /* Content Section */
        #content {
            margin-bottom: 17px;
            font-size: 17px;
            min-height: 200px;
        }

        .links {
            background: #f8f8f8;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px 0;
        }

        .links .prev {
            text-align: left;
        }

        .links .parent {
            text-align: center;
        }

        .links .next {
            text-align: right;
        }


        /* Footer Section */
        footer {
            color: black;
            background: white;
            width: 100%;
            position: absolute;
            bottom: 0;
        }

        footer #copyright {
            padding: 30px;
            text-align: center;
            color: #444;
        }

        footer #copyright p {
            margin: 0;
        }

        footer #copyright span a {
            color: white;
        }

        /* Overide bootsstrap default style */
        table, .table {
            font-size: inherit;
        }
    </style>

</head>
    <body>
    <div class="page-wrapper">
        
<header>
    <div class="container">
        <h3 class="title text-center">
            3.3. Prooph Event Store        </h3>
    </div>
    <div class="links">
        <div class="container">
            <div class="row hidden-sm hidden-md hidden-lg">
    <div class="prev col-xs-6">
                    <p>Prev</p>
            <a href="http://getprooph.org/event-store/repositories.html">3.2. Working with Repositories</a>            </div>
    <div class="next col-xs-6">
                    <p>Next</p>
            <a href="http://getprooph.org/event-store/snapshots.html">3.4. Snapshots</a>            </div>
</div>

<div class="row hidden-xs">
    <div class="prev col-sm-4">
                    <p>Prev</p>
            <a href="http://getprooph.org/event-store/repositories.html">3.2. Working with Repositories</a>            </div>
    <div class="parent col-sm-4">
                    <p>Up</p>
            <a href="http://getprooph.org/event-store/">3. PHP EventStore Implementation</a>            </div>
    <div class="next col-sm-4">
                    <p>Next</p>
            <a href="http://getprooph.org/event-store/snapshots.html">3.4. Snapshots</a>            </div>
</div>

        </div>
    </div>
</header>

<section id="content">
    <div class="container">
        <div class="row">
            <div class="col-md-12">

<h1 id="3.3">3.3. Prooph Event Store</h1>
<p>Prooph Event Store is the central component of this package. If you are familiar with doctrine
you can compare it with doctrine's EntityManager.
However, Prooph Event Store is especially designed to add a centralized, event-driven system on top
of different low level event stream persistence adapters.
The event-driven store is the unique selling point of prooph/event-store compared to other libraries.
So let's directly jump into it and see what you can do with it.</p>
<h2 id="3.3.1">3.3.1. Event Hooks</h2>
<p>Action events are triggered when methods of the event store are invoked. The action events are named like the event store methods and most of them have
a suffix to indicate whether they are triggered before or after the logic of the method itself is executed.
The following events are available (event target is always the event store):</p>
<ul>
<li>
<code>create.pre</code>: event params: <code>stream</code>
</li>
<li>
<code>create.post</code>: event params: <code>stream</code>
</li>
<li>
<code>appendTo.pre</code>: event params: <code>streamName</code>, <code>streamEvents</code>
</li>
<li>
<code>appendTo.post</code>: event params: <code>streamName</code>, <code>streamEvents</code>
</li>
<li>
<code>load.pre</code>: event params: <code>streamName</code>, <code>minVersion</code>
<ul>
<li>If a listener injects a <code>stream</code> as event param and stops the event, the <code>stream</code> is returned immediately (adapter is not invoked)</li>
<li>If <code>stream</code> is false a <code>StreamNotFoundException</code> is thrown</li>
</ul>
</li>
<li>
<code>load.post</code>: event params: <code>streamName</code>, <code>minVersion</code>, <code>stream</code>
<ul>
<li>If a listener stops the event, a <code>StreamNotFoundException</code> is thrown</li>
</ul>
</li>
<li>
<code>loadEventsByMetadataFrom.pre</code>: event params: <code>streamName</code>, <code>minVersion</code>, <code>metadata</code>
<ul>
<li>If a listener injects a <code>streamEvents</code> iterator as event param and stops the event, <code>streamEvents</code> is returned immediately (adapter is not invoked)</li>
</ul>
</li>
<li>
<code>loadEventsByMetadataFrom.post</code>: event params: <code>streamName</code>, <code>minVersion</code>, <code>metadata</code>, <code>streamEvents</code>
<ul>
<li>If a listener stops the event an empty iterator is returned from the method instead of <code>streamEvents</code>
</li>
</ul>
</li>
<li>
<code>beginTransaction</code>: no event params available</li>
<li>
<code>commit.pre</code>: no event params available
<ul>
<li>If a listener stops the event, a transaction rollback is triggered</li>
</ul>
</li>
<li>
<code>commit.post</code>: event params: <code>recordedEvents</code>
<ul>
<li>This is the perfect action event to attach a <code>DomainEventDispatcher</code> which iterates over <code>recordedEvents</code> and publish them</li>
</ul>
</li>
<li>
<code>rollback</code>: no event params available</li>
</ul>
<h2 id="3.3.2">3.3.2. Attaching Plugins</h2>
<p>If you had a look at the quick start you should already be familiar with one possibility to attach an event listener plugin.</p>
<pre><code class="language-php">$eventStore-&gt;getActionEventEmitter()-&gt;attachListener(
    'commit.post',
    function (\Prooph\Common\Event\ActionEvent $actionEvent) {
        //plugin logic here
    }
);
</code></pre>
<p>More complex plugins are typically provided as classes with own dependencies. A plugin can implement the <code>Prooph\EventStore\Plugin\Plugin</code> interface
and can then attach itself to the event store in the <code>Plugin::setUp($eventStore)</code> method.
Implementing the interface is especially useful when you use the event store factory.</p>
<h2 id="3.3.3">3.3.3. Plugin Use Cases</h2>
<p>The event-driven system opens the door for customizations. Here are some ideas what you can do with it:</p>
<ul>
<li>Attach a domain event dispatcher on the <code>commit.post</code> event</li>
<li>Filter events before they are stored</li>
<li>Add event metadata like a <code>causation id</code> (id of the command which caused the event)</li>
<li>Convert events into custom event objects before they are passed back to a repository</li>
<li>Implement your own Unit of Work and synchronizes it with the <code>transaction</code>, <code>commit.pre/post</code> and <code>rollback</code> events</li>
<li>...</li>
</ul>

</div>
</div>
</div>
</section>

<footer>
    <div class="links">
        <div class="container">
            <div class="row hidden-sm hidden-md hidden-lg">
    <div class="prev col-xs-6">
                    <p>Prev</p>
            <a href="http://getprooph.org/event-store/repositories.html">3.2. Working with Repositories</a>            </div>
    <div class="next col-xs-6">
                    <p>Next</p>
            <a href="http://getprooph.org/event-store/snapshots.html">3.4. Snapshots</a>            </div>
</div>

<div class="row hidden-xs">
    <div class="prev col-sm-4">
                    <p>Prev</p>
            <a href="http://getprooph.org/event-store/repositories.html">3.2. Working with Repositories</a>            </div>
    <div class="parent col-sm-4">
                    <p>Up</p>
            <a href="http://getprooph.org/event-store/">3. PHP EventStore Implementation</a>            </div>
    <div class="next col-sm-4">
                    <p>Next</p>
            <a href="http://getprooph.org/event-store/snapshots.html">3.4. Snapshots</a>            </div>
</div>

        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>
                        Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>
    </div>

    <script src="http://tobiju.github.io/share/prismjs/main.js"></script>
    <script src="http://tobiju.github.io/share/prismjs/prism.js"></script>
</body>
</html>
