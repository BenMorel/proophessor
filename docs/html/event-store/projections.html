<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta name="HandheldFriendly" content="True"/>
    <title>Projections</title>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
    <link rel="stylesheet"
          href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
    <style>
        body, html {
            height: 100%;
            padding-top: 36px;
            position: relative;
        }

        img {
            max-width: 100%;
        }

        .page-wrapper {
            min-height: 100%;
            padding-bottom: 170px;
            position: relative;
        }

        /* Header Section */
        header {
            background: white;
            color: black;
            font-size: 16px;
            font-weight: 300;
        }

        h1:first-child {
            margin-top: 0;
        }

        /* anchor link will be displayed after the static top nav */
        h1:before,
        h2:before,
        h3:before,
        h4:before,
        h5:before,
        h6:before {
            display: block;
            content: " ";
            margin-top: -64px;
            height: 64px;
            visibility: hidden;
        }

        .navbar-brand {
            padding: 0;
        }

        .navbar-brand img {
            max-height: 100%;
        }

        /* Content Section */
        #content {
            margin-bottom: 17px;
            font-size: 17px;
            min-height: 200px;
        }

        .breadcrumb {
            position: relative;
            z-index: 999;
        }

        .links {
            background: #f8f8f8;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px 0;
        }

        .links .prev {
            text-align: left;
        }

        .links .parent {
            text-align: center;
        }

        .links .next {
            text-align: right;
        }

        /* TOC */
        .list-toc .list-group-item {
            background: 0 none;
            position: relative;
            font-weight: bold;
            padding: 0;
        }

        .list-toc .list-group-item.level-2 {
            padding-left: 20px;
        }

        .list-toc .list-group-item.level-3 {
            padding-left: 40px;
        }

        .list-toc .list-group-item.level-4 {
            padding-left: 20px;
        }

        .list-toc .list-group-item .row {
            padding: 7px 0;
        }

        .list-toc .list-group-item .text-number {
            padding-left: 10px;
        }

        .list-toc .list-toc-nested .list-group-item {
            font-weight: normal;
            border: 0 none !important;
        }

        .list-toc .list-toc-nested {
            margin-bottom: 0;
            padding-bottom: 10px;
        }

        .list-toc .list-group-item .bbt-toc-toggle {
            display: block;
            position: absolute;
            top: 5px;
            right: 10px;
            font-weight: normal;
        }
        .list-toc .list-group-item .bbt-toc-toggle:before {
            content: "";
            display: block;
        }
        .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
            content: "";
            display: block;
        }

        .list-toc > li:nth-child(2n+1) {
            background: rgba(0, 0, 0, 0.03);
        }

        .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
        .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
        .bbt-theme-slate .list-toc > li:nth-child(2n+1),
        .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
            background: rgba(255, 255, 255, 0.05);
        }

        .list-toc .list-group-item {
            border-bottom: 0 none;
            border-left: 0 none;
            border-right: 0 none;
            font-size: inherit;
        }

        .list-toc .list-group-item:first-child {
            border-top-right-radius: 0;
            border-top-left-radius: 0;
        }

        .list-toc .list-group-item:last-child {
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* Left navigation */
        .nav-left ul li a {
            padding-top: 3px;
            padding-bottom: 3px;
            border-left: 1px solid transparent;
        }
        .nav-left ul li.active a,
        .nav-left ul li a:hover {
            background: none !important;
            color: inherit;
            border-color: inherit;
        }

        .affix {
            top: 60px;
        }

        .badge {
            border-radius: 4px;
            padding: 5px;
        }

        /* Footer Section */
        footer {
            color: black;
            background: white;
            width: 100%;
            position: absolute;
            bottom: 0;
        }

        footer #copyright {
            padding: 30px;
            text-align: center;
            color: #444;
        }

        footer #copyright p {
            margin: 0;
        }

        footer #copyright span a {
            color: white;
        }

        .prooph-logo {
            float: left;
            margin-left: 8px;
            margin-right: 8px;
            transition-timing-function: ease-in-out;
            transition: all 5s;
            height: 50px;
            padding: 5px;
        }

        .prooph-logo:hover {
            transition: all .7s;
            transition-timing-function: ease-out;
            transform: rotate(360deg);
        }

        /* Top Navigation */
        @media (max-width: 767px) {
            ul.navbar-nav {
                margin: 0 -15px
            }

            ul.navbar-nav li {
                border-radius: 0;
            }

            ul.navbar-nav li ul {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                border-radius: 0;
                box-shadow: none;
                display: block;
                float: none;
                left: auto;
                padding: 0;
                position: static;
            }

            ul.navbar-nav li ul li a {
                padding: 8px 30px;
            }

            ul.navbar-nav li ul li ul li a {
                padding: 6px 40px;
            }
        }

        @media (min-width: 768px) {

            ul.navbar-nav li {
                display: block;
                position: relative;
                float: left;
            }

            ul.navbar-nav li ul {
                display: none;
            }

            ul.navbar-nav li a {
                display: block;
            }

            ul.navbar-nav li:hover > ul {
                display: block;
                position: absolute;
            }

            ul.navbar-nav li:hover li {
                float: none;
            }

            ul.navbar-nav ul ul {
                left: 100%;
                top: 0;
            }
        }
    </style>
    </head>
    <body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
    <div class="page-wrapper">
        <header>
    <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
        <a href="/docs/html/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                <defs>
                    <style>
                        .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                    </style>
                </defs>
                <title>prooph-logo</title>
                <g id="artwork">
                    <g id="Layer_5" data-name="Layer 5">
                        <path class="cls-1"
                              d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                        <path class="cls-2"
                              d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                        <path class="cls-3"
                              d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                        <path class="cls-4"
                              d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                        <path class="cls-5"
                              d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                        <path class="cls-6"
                              d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                    </g>
                </g>
            </svg>
        </a>
                        <li>
    <a href="/docs/html/overview/">Overview</a>
    
    <ul class="dropdown-menu">
        <a href="/docs/html/overview/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                <defs>
                    <style>
                        .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                    </style>
                </defs>
                <title>prooph-logo</title>
                <g id="artwork">
                    <g id="Layer_5" data-name="Layer 5">
                        <path class="cls-1"
                              d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                        <path class="cls-2"
                              d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                        <path class="cls-3"
                              d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                        <path class="cls-4"
                              d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                        <path class="cls-5"
                              d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                        <path class="cls-6"
                              d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                    </g>
                </g>
            </svg>
        </a>
                        <li>
    <a href="/docs/html/overview/prooph-in-a-nutshell.html">prooph in a nutshell</a>

    </li>
                        <li>
    <a href="/docs/html/overview/components.html">prooph components</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/docs/html/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
        <a href="/docs/html/service-bus/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                <defs>
                    <style>
                        .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                    </style>
                </defs>
                <title>prooph-logo</title>
                <g id="artwork">
                    <g id="Layer_5" data-name="Layer 5">
                        <path class="cls-1"
                              d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                        <path class="cls-2"
                              d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                        <path class="cls-3"
                              d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                        <path class="cls-4"
                              d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                        <path class="cls-5"
                              d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                        <path class="cls-6"
                              d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                    </g>
                </g>
            </svg>
        </a>
                        <li>
    <a href="/docs/html/service-bus/intro.html">PSB - ProophServiceBus</a>

    </li>
                        <li>
    <a href="/docs/html/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/docs/html/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/docs/html/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/docs/html/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/docs/html/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/docs/html/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
        <a href="/docs/html/event-store/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                <defs>
                    <style>
                        .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                    </style>
                </defs>
                <title>prooph-logo</title>
                <g id="artwork">
                    <g id="Layer_5" data-name="Layer 5">
                        <path class="cls-1"
                              d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                        <path class="cls-2"
                              d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                        <path class="cls-3"
                              d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                        <path class="cls-4"
                              d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                        <path class="cls-5"
                              d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                        <path class="cls-6"
                              d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                    </g>
                </g>
            </svg>
        </a>
                        <li>
    <a href="/docs/html/event-store/intro.html">ProophEventStore</a>

    </li>
                        <li>
    <a href="/docs/html/event-store/event_store.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/docs/html/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/docs/html/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/docs/html/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/docs/html/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
        <a href="/docs/html/event-sourcing/">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                <defs>
                    <style>
                        .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                    </style>
                </defs>
                <title>prooph-logo</title>
                <g id="artwork">
                    <g id="Layer_5" data-name="Layer 5">
                        <path class="cls-1"
                              d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                        <path class="cls-2"
                              d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                        <path class="cls-3"
                              d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                        <path class="cls-4"
                              d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                        <path class="cls-5"
                              d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                        <path class="cls-6"
                              d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                    </g>
                </g>
            </svg>
        </a>
                        <li>
    <a href="/docs/html/event-sourcing/intro.html">ProophEventSourcing</a>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/snapshots.html">Snapshots</a>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/docs/html/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/docs/html/">prooph components documentation</a></li>
                                <li><a href="/docs/html/event-store/">Event Store</a></li>
                                <li class="active">Projections</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-3" title="Projections">Projections</a>
            </li>
                                <li>
                <a href="#3-3-1" title="Queries">Queries</a>
            </li>
                                <li>
                <a href="#3-3-2" title="Projections">Projections</a>
            </li>
                                            <li>
                <a href="#3-3-3" title="Read&#x20;Model&#x20;Projections">Read Model Projections</a>
            </li>
                                                        <li>
                <a href="#3-3-4" title="Projection&#x20;Manager">Projection Manager</a>
            </li>
                                <li>
                <a href="#3-3-5" title="Internal&#x20;projection&#x20;mames">Internal projection mame...</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-3">Projections</h1>
<p>New in v7 are queries and projectons.</p>
<h2 id="3-3-1">Queries</h2>
<p>We are talking here about event store queries, not queries on your read model. An event store query reads one or
multiple event stream, aggregates some state from it and makes it accessible. A query is non-persistent, will only
get executed once, return a result, and that's it.</p>
<p>To get started, let's take a simple example where we want to query the
event-store, how often a given user has changed his username.</p>
<pre><code class="language-php">$query = $projectionManager-&gt;createQuery();
$query
    -&gt;init(function (): array {
        return ['count' =&gt; 0];
    })
    -&gt;fromStream('user-123')
    -&gt;when([
        'user-name-changed' =&gt; function (
            array $state, UsernameChanged $event
        ): array {
            $state['count']++;
            return $state;
        }
    ])
    -&gt;run();

echo 'user 123 changed his name ' . $query-&gt;getState()['count'] . ' times';
</code></pre>
<p>You can also reset and run the query again:</p>
<pre><code class="language-php">$query-&gt;reset();
$query-&gt;run();
</code></pre>
<p>Or you can stop the projection at any point in time.</p>
<pre><code class="language-php">$query = $projectionManager-&gt;createQuery();
$query
    -&gt;init(function (): array {
        return ['count' =&gt; 0];
    })
    -&gt;fromStream('user-123')
    -&gt;when([
        'user-name-changed' =&gt; function (
            array $state, UsernameChanged $event
        ): array {
            $state['count']++;
            $this-&gt;stop(); // stop query now
            return $state;
        }
    ])
    -&gt;run();
</code></pre>
<p>Queries can be used to answer a given question easily, because you don't need to figure out in which read model the
data is present (maybe it's not?) and how to query it there (maybe a lot of joins are needed in RDBMS).
Also you can do temporal queries very easy, which is hard until impossible to do with any other database system.</p>
<h2 id="3-3-2">Projections</h2>
<p>Projections are like queries, but first of all, they are persistent, the created state is persistent and can be queried
later, and also the projection is running forever (in most cases).</p>
<p>Compared to queries, the projectors have a couple of additional methods:</p>
<pre><code class="language-php">public function getName(): string;

public function emit(Message $event): void;

public function linkTo(string $streamName, Message $event): void;

public function delete(bool $deleteEmittedEvents): void;
</code></pre>
<ul>
<li>getName() - obviously returns the given name of that projection</li>
<li>emit(Message $event) - emits a new event that will be persisted on a stream with the same name as the projection</li>
<li>linkTo(string $streamName, Message $event) - emits a new event, that will be persisted on a specific stream</li>
<li>delete(bool $deleteEmittedEvents) - deletes the projection completely, the <code>$deleteEmittedEvents</code> flag tells, whether or not to delete emitted events.</li>
</ul>
<p>An example:</p>
<pre><code class="language-php">$projector = $projectionManager-&gt;createProjection('test_projection');
$projector
    -&gt;fromStream('user-123')
    -&gt;whenAny(
        function (array $state, Message $event): array {
            $this-&gt;linkTo('foo', $event); // create a copy of the event to a new stream
            return $state;
        }
    )
    -&gt;run();
</code></pre>
<pre><code class="language-php">$projector = $projectionManager-&gt;createProjection('test_projection');
$projector
    -&gt;init(function (): array {
        return ['count' =&gt; 0];
    })
    -&gt;fromCategory('user')
    -&gt;when([
        'user-registered' =&gt; function (array $state, Message $event): array {
            $state['count']++;
            return $state;
        }
    )
    -&gt;run();
</code></pre>
<p>This would count all registered users.</p>
<h3 id="3-3-2-1">Options</h3>
<p>There are three options common to all projectors:</p>
<p>OPTION_CACHE_SIZE = 'cache_size';</p>
<p>The cache size is how many stream names are cached in memory, the higher the number to less queries are executed and therefor
makes the projections run faster, but it consumes more memory.</p>
<p>OPTION_SLEEP = 'sleep';</p>
<p>The sleep options tells the projection to sleep that many microseconds, before querying the event store again, when no events
were found in the last trip. This reduces having lots of cpu cycles without the projection doing anything really.</p>
<p>OPTION_PERSIST_BLOCK_SIZE = 'persist_block_size';</p>
<p>The persist block size tells the projector, to persist its changes after a given amount of operations. This increases the speed
of the projection a lot. When you persist only every 1000 events compared to persist on every event, then 999 write operations
are saved. The higher the number, the less write operations are made to your system, making the projections run faster.
On the other side, in case of an error, you need to redo the last operations again. If you are publishing events to the outside
world within a projection, you may think of a persist block size of 1 only.</p>
<p>OPTION_LOCK_TIMEOUT_MS = 'lock_timeout_ms'</p>
<p>Indicates the time (in microseconds) the projector is locked. During this time no other projector with the same name can
be started. A running projector will update the lock timeout on every loop.</p>
<h2 id="3-3-3">Read Model Projections</h2>
<p>Projections can also be used to create read models. A read model has to implement <code>Prooph\EventStore\Projection\ReadModel</code>.
Prooph also ships with an <code>Prooph\EventStore\Projection\AbstractReadModel</code> that helps you to implement a read model yourself.</p>
<p>One nice thing about read model projections is, that you don't need a migration script for your read models at all.
When you need to make a change to your read model, you simply alter your read model implementation, stop your
current running projections, reset it and run it again.</p>
<h3 id="3-3-3-1">Options</h3>
<p>The read model projectors have the same options as the normal projectors, see above for more explanations.</p>
<h3 id="3-3-3-2">Example</h3>
<pre><code class="language-php">$projector = $projectionManager-&gt;createReadModelProjection(
    'test_projection',
    $readModel
);

$projector
    -&gt;fromAll()
    -&gt;when([
        'user-created' =&gt; function ($state, Message $event) {
            $this-&gt;readModelProjection()-&gt;insert(
                'name',
                $event-&gt;payload()['name']
            );
        },
        'username-changed' =&gt; function ($state, Message $event) {
            $this-&gt;readModelProjection()-&gt;update(
                'name',
                $event-&gt;payload()['name']
            );
        }
    ])
    -&gt;run();
</code></pre>
<h2 id="3-3-4">Projection Manager</h2>
<p>The projection manager can do the following for you:</p>
<ul>
<li>Create queries &amp; projectors</li>
<li>Delete / reset / stop projections</li>
<li>Fetch projection names</li>
<li>Fetch projection status</li>
<li>Fetch projection stream position</li>
<li>Fetch projection state</li>
</ul>
<p>While the most is pretty straightforward, the delete / reset / stop projection methods may need some additional
explanation:</p>
<p>When you call stopProjection($name) (or delete or reset) a message is send to the projection. This will notify the
running projection, that it should act accordingly. This means, that once you call <code>stopProjection</code> the projection
might not be stopped immediately, but it could take a few seconds until the projection is finally stopped.</p>
<h2 id="3-3-5">Internal projection mames</h2>
<p>All internal projetion names are prefixed with <code>$</code> (dollar-sign), f.e. <code>$ct-</code>. Do not use projection names starting
with a dollar-sign, as this is reserved for prooph internals.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/docs/html/event-store/event_store.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/docs/html/event-store/upcasting.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/prooph/bookdown-template" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
    </div>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <script src="https://prooph.github.io/share/prismjs/main.js"></script>
    <script src="https://prooph.github.io/share/prismjs/prism.js"></script>
</body>
</html>
